# Telegram Forum Post Manager

Telegram-бот для управления публикацией постов в группу-форум через админ-панель. Бот позволяет группе администраторов создавать, редактировать и удалять посты в целевом топике форума, используя настраиваемые типы постов с изображениями и текстовыми шаблонами.

## Возможности

### Управление постами
- **Создание постов** — выбор типа поста, ввод текста, предпросмотр и публикация в форум
- **Редактирование постов** — изменение текста опубликованных постов с сохранением изображений
- **Удаление постов** — удаление постов из форума и базы данных
- **Отмена операций** — команда `/cancel` для отмены текущей операции на любом этапе

### Управление типами постов
- **Создание типов** — настройка названия, изображения и текстового шаблона
- **Редактирование типов** — изменение названия, замена изображения или шаблона
- **Активация/деактивация** — временное отключение типов без удаления
- **Список типов** — просмотр всех существующих типов с возможностью управления

### Настройки доступа
- **Управление администраторами** — добавление и удаление Telegram ID администраторов
- **Настройка форума** — указание ID целевой группы-форума
- **Настройка топика** — указание ID топика для публикации постов

### Резервное копирование
- **💾 Бэкап базы данных** — создание полного SQL-дампа базы данных
- **Отправка через Telegram** — получение файла бэкапа прямо в чат

## Архитектура

```
┌─────────────┐
│   Telegram  │
│     API     │
└──────┬──────┘
       │
       ▼
┌────────────────────────────────────┐
│    Forum Admin Handler             │
│  ┌──────────────────────────────┐  │
│  │   Admin Authorization        │  │
│  │   Middleware                 │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Command Router             │  │
│  │   /admin, /new, /edit, etc.  │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   FSM State Manager          │  │
│  │   (Admin State Tracking)     │  │
│  └──────────────────────────────┘  │
└─────────────┬──────────────────────┘
              │
              ▼
┌────────────────────────────────────┐
│        Service Layer               │
│  ┌──────────────────────────────┐  │
│  │   Post Manager Service       │  │
│  │   (Create, Edit, Delete)     │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Post Type Manager Service  │  │
│  │   (CRUD for Post Types)      │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Settings Manager Service   │  │
│  │   (Admin IDs, Forum Config)  │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Backup Manager Service     │  │
│  │   (Database Backup)          │  │
│  └──────────────────────────────┘  │
└─────────────┬──────────────────────┘
              │
              ▼
┌────────────────────────────────────┐
│       Repository Layer             │
│  ┌──────────────────────────────┐  │
│  │   Post Type Repository       │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Published Post Repository  │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Admin Config Repository    │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Admin State Repository     │  │
│  └──────────────────────────────┘  │
└─────────────┬──────────────────────┘
              │
              ▼
┌────────────────────────────────────┐
│         Database Layer             │
│         (SQLite + DBQueue)         │
└────────────────────────────────────┘
```

### Ключевые решения

- **SQLite как единственный источник истины** — всё состояние хранится в БД, FSM восстанавливается на каждый update
- **Single-writer DB Queue** — все операции с БД через единственный goroutine с retry (3 попытки)
- **Pure Go SQLite** — используется `modernc.org/sqlite` без CGO, что позволяет собирать через ko.build
- **FSM для многошаговых операций** — отслеживание состояния администратора при создании/редактировании постов
- **Авторизация через middleware** — проверка прав доступа для всех операций

## Структура проекта

```
├── cmd/bot/main.go           # Точка входа
├── internal/
│   ├── db/                   # Репозитории и работа с БД
│   │   ├── queue.go          # Single-writer DB Queue
│   │   ├── schema.go         # Схема БД и миграции
│   │   ├── post_type_repository.go
│   │   ├── published_post_repository.go
│   │   ├── admin_config_repository.go
│   │   └── admin_state_repository.go
│   ├── fsm/                  # FSM состояния
│   │   └── states.go
│   ├── handlers/             # Обработчики Telegram updates
│   │   └── forum_admin_handler.go
│   ├── models/               # Модели данных
│   │   ├── post_type.go
│   │   ├── published_post.go
│   │   ├── admin_config.go
│   │   ├── admin_state.go
│   │   └── types.go
│   └── services/             # Бизнес-логика
│       ├── post_manager.go   # Управление постами
│       ├── post_type_manager.go # Управление типами
│       ├── settings_manager.go # Управление настройками
│       ├── backup_manager.go # Создание бэкапов
│       ├── admin_auth_middleware.go # Авторизация
│       └── escaping.go       # Экранирование текста
├── Dockerfile
├── docker-compose.yml
├── Makefile
└── .ko.yaml                  # Конфигурация ko.build
```

## Установка и запуск

### Требования
- Go 1.25+
- Docker и Docker Compose (для контейнеризации)
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Права бота в целевой группе-форуме

### Локальный запуск

```bash
# Клонировать репозиторий
git clone https://github.com/ad/go-telegram-admin.git
cd go-telegram-admin

# Создать .env файл
cp .env.example .env
# Отредактировать .env, указав BOT_TOKEN, ADMIN_IDS, FORUM_CHAT_ID, TOPIC_ID

# Запустить
go run ./cmd/bot
```

### Docker

```bash
# Создать .env файл
cp .env.example .env
# Отредактировать .env

# Собрать и запустить
docker compose up -d

# Посмотреть логи
docker compose logs -f

# Остановить
docker compose down
```

### Makefile команды

```bash
make build      # Собрать Docker образ
make up         # Запустить через docker compose
make down       # Остановить
make run        # Запустить локально (go run)
make test       # Запустить тесты
make build-ko   # Собрать через ko (локально)
make push       # Собрать и запушить через ko
make clean      # Удалить локальную БД
```

## Конфигурация

Переменные окружения:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `BOT_TOKEN` | Токен Telegram бота | обязательно |
| `ADMIN_IDS` | Список Telegram ID администраторов (через запятую) | обязательно |
| `FORUM_CHAT_ID` | ID целевой группы-форума | обязательно |
| `TOPIC_ID` | ID топика для публикации | обязательно |
| `DB_PATH` | Путь к файлу SQLite | `admin.db` |

### Пример .env файла

```bash
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
ADMIN_IDS=123456789,987654321
FORUM_CHAT_ID=-1001234567890
TOPIC_ID=42
DB_PATH=admin.db
```

## Использование

### Команды для администраторов
- `/admin` — открыть главное меню админ-панели
- `/new` — создать новый пост
- `/edit` — редактировать существующий пост
- `/delete` — удалить пост
- `/cancel` — отменить текущую операцию

### Главное меню админ-панели

При вызове `/admin` отображается меню с кнопками:
- **Новый пост** — создание и публикация нового поста
- **Редактировать пост** — изменение текста опубликованного поста
- **Удалить пост** — удаление поста из форума
- **Настройки** — управление типами постов и настройками доступа

### Создание поста

1. Выберите тип поста из списка активных типов
2. Скопируйте текстовый шаблон (отображается в `<code>` тегах)
3. Отредактируйте и отправьте текст поста
4. Просмотрите предпросмотр с изображением (если есть)
5. Подтвердите публикацию или отмените через `/cancel`

### Редактирование поста

1. Вызовите `/edit` или выберите "Редактировать пост" в меню
2. Отправьте ссылку на пост (из Telegram)
3. Отправьте новый текст для поста
4. Пост будет обновлен с сохранением изображения

### Удаление поста

1. Вызовите `/delete` или выберите "Удалить пост" в меню
2. Отправьте ссылку на пост
3. Пост будет удален из форума и базы данных

### Настройки

В подменю настроек доступны:
- **Новый тип** — создание нового типа поста с изображением и шаблоном
- **Типы постов** — управление существующими типами (редактирование, отключение)
- **Настройки доступа** — управление списком администраторов и настройками форума
- **💾 Бэкап** — создание и отправка SQL-дампа базы данных

### Управление типами постов

#### Создание типа
1. Выберите "Новый тип" в настройках
2. Отправьте название типа
3. Отправьте изображение (или пропустите, отправив любой текст)
4. Отправьте текстовый шаблон
5. Тип будет создан и доступен при создании постов

#### Редактирование типа
1. Выберите "Типы постов" в настройках
2. Выберите тип из списка
3. Выберите действие:
   - Изменить название
   - Заменить изображение
   - Заменить шаблон
   - Отключить/включить тип

### Бэкап базы данных

Функция **💾 Бэкап** позволяет:
- Создать полный SQL-дамп базы данных одним нажатием
- Получить файл с бэкапом прямо в Telegram
- Восстановить данные на другом сервере

Бэкап включает все таблицы: типы постов, опубликованные посты, настройки администраторов. Файл создается в формате, совместимом с командой `sqlite3 admin.db < backup.sql`.

## Восстановление из бэкапа

### Полная замена базы данных

```bash
# 1. Остановить бот
docker compose down

# 2. Создать резервную копию текущей БД (опционально)
cp admin.db admin.db.backup

# 3. Удалить старую базу
rm admin.db admin.db-wal admin.db-shm

# 4. Восстановить из бэкапа
sqlite3 admin.db < backup_2026-02-14_12-30-45.sql

# 5. Запустить бот
docker compose up -d
```

### Безопасное восстановление (с сохранением оригинала)

```bash
# 1. Остановить бот
docker compose down

# 2. Создать новую базу из бэкапа
sqlite3 admin_new.db < backup_2026-02-14_12-30-45.sql

# 3. Заменить базы местами
mv admin.db admin.db.backup
mv admin_new.db admin.db

# 4. Запустить бот
docker compose up -d
```

## База данных

SQLite с WAL режимом для лучшей производительности. Схема создаётся автоматически при первом запуске.

### Таблицы
- `post_types` — типы постов с названием, изображением и шаблоном
- `published_posts` — опубликованные посты с привязкой к типу
- `admin_config` — настройки администраторов и форума
- `admin_state` — состояние FSM для многошаговых операций

## Права бота в Telegram

Бот должен иметь следующие права в целевой группе-форуме:
- Отправка сообщений
- Отправка фото
- Редактирование сообщений
- Удаление сообщений
- Доступ к топикам

Для настройки прав:
1. Добавьте бота в группу-форум
2. Сделайте бота администратором
3. Включите необходимые права
4. Получите ID группы и топика (можно через [@userinfobot](https://t.me/userinfobot))

## Тестирование

Проект использует property-based тестирование с библиотекой [rapid](https://github.com/flyingmutant/rapid).

```bash
# Запустить все тесты
make test

# Запустить с verbose
go test -v ./...

# Запустить только property-based тесты
go test -v ./internal/... -run "Property"
```

## CI/CD с ko.build

Для production-сборки используется [ko](https://ko.build/) — инструмент для сборки Go-приложений в OCI-образы без Dockerfile.

```bash
# Установить ko
go install github.com/google/ko@latest

# Собрать локально
ko build --local ./cmd/bot

# Собрать и запушить в registry
export KO_DOCKER_REPO=ghcr.io/your-username
ko build ./cmd/bot
```

## Лицензия

MIT
